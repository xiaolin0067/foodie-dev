# 1 已鉴权通过接口调用

## 名次解释

令牌：允许访问一次接口的凭证

## 1.1 租户限流逻辑

1、获取当前ft-openapi所有节点（默认每个节点的全局并发支持为300QPS，单接口并发支持50QPS）

2、获取所有正在调用API接口的租户，统计其QPS

### 1.1.1 租户间QPS分配策略

#### 动态分配

- 根据租户的API调用QPS比例

  通过监控获取租户QPS

  > 租户QPS限制 = 租户QPS调用比例 * 总限流数

  **问题**：租户调用越多，获得到的比例就越大，其他租户占用比例越小，会受影响。

- 配置租户比例

  默认平均分配，也可手动配置自动刷新

  > 租户QPS限制 = 租户配置比例 * 总限流数

  **问题**：有低QPS租户时，会造成服务资源得不到充分利用。

- 计算租户比例

  租户QPS调用与配置租户比例合并，同比求均值。

  > 租户QPS限制 = （（租户配置比例 + 租户QPS调用比例） / 2） * 总限流数
  >

- 加权计算租户比例（想采用这种计算方式）

  租户比例占小一点，更多的以租户访问QPS比例来分配，这个比例可以动态调整，比如按照 2:3 那么有
  
  > 租户QPS限制 = （租户配置比例 * 2/5 + 租户QPS调用比例 * 3/5） * 总限流数

#### 固定配置（互斥于动态分配）

- 固定配置指定租户的QPS数量，如有此配置，动态分配策略无效。

### 1.2 共享QPS

将全局支持的QPS划分为租户QPS、共享QPS两部分，超过租户分配的QPS，可以从共享中进行获取。

- 共享的比例大，租户私有的比例少

  优点：可以充分利用资源

  缺点：租户可自由抢占的空间更大，会有租户抢占过多QPS其他租户饥饿的情况。

- 共享的比例小，租户私有的比例大

  优点：每个租户的令牌分配更均衡，租户之间的令牌不会存在悬殊的差距

  缺点：资源得不到充分的利用，可能存在租户拿到较多令牌，但是他没有那么多QPS的情况。

如果默认比例为，共享20%，租户分配的QPS占比80%，若配置比例则以配置的为准，这个比例最好是需要通过线上数据来计算。

若单进程300 QPS，那么共享30，租户间分配270

## 1.2 实现工具

### 单机限流

仍然使用目前的resilience4j

### 分布式限流 -- 需要重写现有单机限流逻辑

- Redission

  算法：令牌桶

  优点：无需新依赖，目前项目中有在使用

- Sentinel

  算法：滑动窗口，漏桶

  缺点：需要添加新依赖

  优点：有完善的日志打印，支持WEB控制台Dashboard（需单独部署）可以方便的动态调整限流规则。
  

分布式限流中间件出现问题时，降级为单机限流。


### 单机 VS 分布式

集群下，分布式限流会使得限流更加准确

# 2 对于未认证的接口

1、鉴权接口未权限校验，可以IP限流（好像目前没有恶意调用）





